<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniNotes AI - Class Notes Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e1b4b;
            --bg-panel: rgba(30, 41, 59, 0.8);
            --accent: #6366f1;
            --accent-light: #818cf8;
            --accent-secondary: #c084fc;
            --success: #10b981;
            --warning: #f59e0b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            padding: 1rem 2rem;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-light), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 6rem 2rem 2rem;
        }

        .upload-section {
            max-width: 700px;
            margin: 4rem auto;
            text-align: center;
        }

        .title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--accent-light), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.125rem;
            margin-bottom: 3rem;
        }

        .upload-card {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 3rem;
        }

        .drop-zone {
            border: 2px dashed rgba(99, 102, 241, 0.3);
            border-radius: 0.75rem;
            padding: 4rem 2rem;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(15, 23, 42, 0.5);
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1.5rem;
            color: var(--accent);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .workspace {
            display: none;
        }

        .workspace.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toolbar {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-icon {
            width: 48px;
            height: 48px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .badge-slides {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent-light);
        }

        .badge-doc {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            height: calc(100vh - 280px);
            min-height: 600px;
        }

        @media (max-width: 1024px) {
            .grid { grid-template-columns: 1fr; height: auto; }
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-content {
            flex: 1;
            overflow: auto;
            padding: 1.5rem;
        }

        .slide-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .slide-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slide-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent);
        }

        .slide-item.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--accent);
        }

        .slide-number {
            display: inline-block;
            background: var(--accent);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .slide-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .slide-preview {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .image-card {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .image-card:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .image-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .image-card:hover .image-overlay {
            opacity: 1;
        }

        .editor-container {
            position: relative;
            height: 100%;
        }

        .textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            padding: 1.5rem;
        }

        .preview {
            height: 100%;
            overflow: auto;
            display: none;
            color: var(--text-primary);
            line-height: 1.6;
            padding: 1.5rem;
        }

        .preview.active {
            display: block;
        }

        .preview h1 {
            color: var(--accent);
            font-size: 1.8rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 0.5rem;
        }

        .preview h2 {
            color: var(--accent-light);
            font-size: 1.4rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .preview h3 {
            color: var(--accent-secondary);
            font-size: 1.1rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .preview ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .preview li {
            margin-bottom: 0.5rem;
        }

        .preview strong {
            color: var(--accent-secondary);
            background: rgba(192, 132, 252, 0.1);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
        }

        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            padding: 0.75rem;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            z-index: 10;
            color: white;
            font-weight: 600;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .panel-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mode-toggle {
            display: flex;
            gap: 0.25rem;
            background: rgba(0,0,0,0.3);
            padding: 0.25rem;
            border-radius: 0.5rem;
        }

        .mode-btn {
            padding: 0.4rem 1rem;
            border-radius: 0.375rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--accent);
            color: white;
        }

        .hidden { display: none !important; }

        .alert {
            position: fixed;
            top: 100px;
            right: 2rem;
            background: rgba(239, 68, 68, 0.95);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            display: none;
            z-index: 9999;
            animation: slideIn 0.3s;
            max-width: 400px;
            color: white;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .slide-count-badge {
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        /* Print styles for PDF generation */
        @media print {
            body * {
                visibility: hidden;
            }
            #pdf-content, #pdf-content * {
                visibility: visible;
            }
            #pdf-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                color: black;
                padding: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="alert" id="alert">
        <span id="alertText">Error message</span>
    </div>

    <nav class="navbar">
        <div class="nav-content">
            <div class="brand">UniNotes AI</div>
            <div style="color: var(--text-secondary); font-size: 0.875rem;">
                Class Notes Generator
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Upload Section -->
        <div id="uploadSection" class="upload-section">
            <h1 class="title">
                Generate Class Notes from<br>
                <span class="gradient-text">Your Lecture Slides</span>
            </h1>
            <p class="subtitle">
                Upload PowerPoint, PDF, or Word documents. Get organized, slide-by-slide notes 
                with key concepts, summaries, and exam prep materials.
            </p>

            <div class="upload-card">
                <div id="dropZone" class="drop-zone">
                    <input type="file" id="fileInput" accept=".pdf,.pptx,.docx" style="display: none;">
                    
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    
                    <h3 style="margin-bottom: 0.5rem; font-size: 1.25rem;">Drop your lecture file here</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">or click to browse</p>
                    
                    <div style="display: flex; justify-content: center; gap: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                        <span style="padding: 0.25rem 0.75rem; background: rgba(255,255,255,0.1); border-radius: 0.25rem;">üìä PowerPoint</span>
                        <span style="padding: 0.25rem 0.75rem; background: rgba(255,255,255,0.1); border-radius: 0.25rem;">üìÑ PDF</span>
                        <span style="padding: 0.25rem 0.75rem; background: rgba(255,255,255,0.1); border-radius: 0.25rem;">üìù Word</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workspace Section -->
        <div id="workspace" class="workspace">
            <div class="toolbar">
                <div class="file-info">
                    <div class="file-icon" id="fileIcon">üìÑ</div>
                    <div>
                        <div id="fileName" style="font-weight: 600;">document.pptx</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem;">
                            <span id="contentStats">0 slides</span>
                            <span id="fileBadge" class="badge badge-slides">Slides</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-secondary" onclick="resetApp()">New File</button>
                    <button class="btn btn-primary" id="generateBtn" onclick="generateNotes()">
                        Generate Class Notes
                    </button>
                </div>
            </div>

            <div class="grid">
                <!-- Slides Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span id="slideCountBadge" class="slide-count-badge">0</span>
                            <span id="slidesTitle">Slides</span>
                        </div>
                    </div>
                    <div class="panel-content" style="padding: 0;">
                        <div id="slidesList" class="slide-list" style="padding: 1rem;">
                            <!-- Slides populated here -->
                        </div>
                        <div id="imageGallery" class="hidden" style="padding: 0 1rem 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 600;">
                                Extracted Images
                            </div>
                            <div class="image-grid" id="imageGrid"></div>
                        </div>
                    </div>
                </div>

                <!-- Notes Panel -->
                <div class="panel" style="position: relative;">
                    <div id="statusBar" class="status-bar">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span>Generating structured notes...</span>
                    </div>

                    <div class="panel-header">
                        <div class="panel-title">üìù Class Notes</div>
                        <div class="mode-toggle">
                            <button class="mode-btn active" onclick="setMode('edit')" id="editBtn">Edit</button>
                            <button class="mode-btn" onclick="setMode('preview')" id="previewBtn">Preview</button>
                        </div>
                    </div>

                    <div class="panel-content" style="padding: 0; position: relative;">
                        <div class="editor-container">
                            <textarea id="notesEditor" class="textarea" placeholder="Click 'Generate Class Notes' to create structured notes from your slides..."></textarea>
                            <div id="notesPreview" class="preview"></div>
                        </div>
                    </div>

                    <div class="panel-footer">
                        <span id="wordCount" class="text-secondary" style="font-size: 0.875rem;">0 words</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="downloadMarkdown()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                Markdown
                            </button>
                            <button onclick="downloadPDF()" id="downloadBtn" class="btn btn-primary" style="background: var(--success);" disabled>
                                Download PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let slidesData = [];
        let currentImages = [];
        let isGenerating = false;
        let currentFileType = 'document';

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const workspace = document.getElementById('workspace');

        // Event Listeners
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            const validTypes = [
                'application/pdf',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            ];
            
            if (!validTypes.includes(file.type)) {
                showAlert('Please upload PDF, PPTX, or DOCX files only.');
                return;
            }

            // Show loading
            dropZone.innerHTML = `
                <div style="text-align: center; color: var(--accent);">
                    <div style="width: 64px; height: 64px; margin: 0 auto 1rem; border: 4px solid rgba(99,102,241,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <h3>Processing Slides...</h3>
                </div>
            `;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    slidesData = data.slides || [];
                    currentImages = data.images || [];
                    currentFileType = data.file_type || 'document';
                    
                    // Switch to workspace
                    uploadSection.style.display = 'none';
                    workspace.classList.add('active');
                    
                    // Update UI
                    document.getElementById('fileName').textContent = file.name;
                    updateFileAppearance(data.file_type, data.slide_count);
                    
                    // Render slides list
                    renderSlidesList();
                    
                    // Render images if any
                    if (currentImages.length > 0) {
                        renderImages();
                    }
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showAlert('Error: ' + error.message);
                console.error(error);
                resetApp();
            }
        }

        function updateFileAppearance(type, count) {
            const icon = document.getElementById('fileIcon');
            const badge = document.getElementById('fileBadge');
            const stats = document.getElementById('contentStats');
            const slidesTitle = document.getElementById('slidesTitle');
            const badgeCount = document.getElementById('slideCountBadge');
            
            if (type === 'slides') {
                icon.textContent = 'üìä';
                badge.textContent = 'PowerPoint Slides';
                badge.className = 'badge badge-slides';
                stats.textContent = `${count} slides`;
                slidesTitle.textContent = 'Slides';
            } else if (type === 'pdf') {
                icon.textContent = 'üìÑ';
                badge.textContent = 'PDF Document';
                badge.className = 'badge badge-doc';
                stats.textContent = `${count} pages`;
                slidesTitle.textContent = 'Pages';
            } else {
                icon.textContent = 'üìù';
                badge.textContent = 'Word Document';
                badge.className = 'badge badge-doc';
                stats.textContent = `${count} sections`;
                slidesTitle.textContent = 'Sections';
            }
            
            badgeCount.textContent = count;
        }

        function renderSlidesList() {
            const container = document.getElementById('slidesList');
            container.innerHTML = '';
            
            slidesData.forEach((slide, idx) => {
                const div = document.createElement('div');
                div.className = 'slide-item';
                div.onclick = () => selectSlide(idx);
                
                const title = slide.title || `${currentFileType === 'slides' ? 'Slide' : 'Page'} ${slide.number}`;
                const preview = slide.content.substring(0, 60) + (slide.content.length > 60 ? '...' : '');
                
                div.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <span class="slide-number">${slide.number}</span>
                        <div style="flex: 1; min-width: 0;">
                            <div class="slide-title">${title}</div>
                            <div class="slide-preview">${preview || 'No text content'}</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function renderImages() {
            document.getElementById('imageGallery').classList.remove('hidden');
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '';
            
            currentImages.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = 'image-card';
                div.innerHTML = `
                    <img src="${img.src}" alt="Slide ${img.slide} image">
                    <div class="image-overlay" onclick="insertImage(${idx})">
                        Add to Notes
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function selectSlide(index) {
            document.querySelectorAll('.slide-item').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });
        }

        function analyzeSlideContent(slide) {
            const text = slide.content.toLowerCase();
            const words = slide.content.match(/\b[A-Za-z]{4,}\b/g) || [];
            
            const originalWords = slide.content.match(/\b[A-Z][a-z]{2,}\b/g) || [];
            const uniqueTerms = [...new Set(originalWords)].slice(0, 5);
            
            let type = 'content';
            if (slide.number === 1 && (slide.title.toLowerCase().includes('title') || words.length < 20)) {
                type = 'title';
            } else if (slide.content.length < 100) {
                type = 'summary';
            }
            
            const bullets = slide.content
                .split(/[.\n]/)
                .map(s => s.trim())
                .filter(s => s.length > 20 && s.length < 150)
                .slice(0, 4);
            
            const definitions = [];
            const defPatterns = [
                /([A-Z][a-z]+(?:\s+[a-z]+){0,3})\s+(?:is|are|refers? to|means?|defined as)\s+([^.\n]+)/gi,
                /([A-Z][a-zA-Z\s]{2,20})\s*:\s*([^.\n]+)/g
            ];
            
            defPatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(slide.content)) !== null) {
                    definitions.push({
                        term: match[1].trim(),
                        def: match[2].trim()
                    });
                }
            });
            
            return {
                type,
                terms: uniqueTerms,
                bullets: bullets.length > 0 ? bullets : [slide.content.substring(0, 120) + '...'],
                definitions: definitions.slice(0, 2),
                wordCount: words.length
            };
        }

        async function generateNotes() {
            if (isGenerating || slidesData.length === 0) return;
            
            isGenerating = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('statusBar').style.display = 'flex';
            
            const editor = document.getElementById('notesEditor');
            editor.value = '';
            
            try {
                let notes = '';
                
                // Header
                notes += `# Class Notes\n\n`;
                notes += `**Source:** ${document.getElementById('fileName').textContent}\n`;
                notes += `**Total ${currentFileType === 'slides' ? 'Slides' : 'Pages'}:** ${slidesData.length}\n`;
                notes += `**Generated:** ${new Date().toLocaleDateString()}\n\n`;
                
                notes += `---\n\n`;
                
                // Table of Contents
                notes += `## üìã Contents\n\n`;
                slidesData.forEach(slide => {
                    const title = slide.title || `Slide ${slide.number}`;
                    notes += `${slide.number}. ${title}\n`;
                });
                notes += `\n---\n\n`;
                
                // Process each slide
                for (let i = 0; i < slidesData.length; i++) {
                    const slide = slidesData[i];
                    const analysis = analyzeSlideContent(slide);
                    
                    notes += `## ${slide.number}. ${slide.title || 'Overview'}\n\n`;
                    
                    if (analysis.terms.length > 0) {
                        notes += `**Key Terms:** ${analysis.terms.join(', ')}\n\n`;
                    }
                    
                    notes += `### Main Points:\n`;
                    analysis.bullets.forEach(bullet => {
                        let formatted = bullet;
                        analysis.terms.forEach(term => {
                            const regex = new RegExp(`\\b${term}\\b`, 'g');
                            formatted = formatted.replace(regex, `**${term}**`);
                        });
                        notes += `‚Ä¢ ${formatted}\n`;
                    });
                    notes += `\n`;
                    
                    if (analysis.definitions.length > 0) {
                        notes += `### Definitions:\n`;
                        analysis.definitions.forEach(def => {
                            notes += `‚Ä¢ **${def.term}**: ${def.def}\n`;
                        });
                        notes += `\n`;
                    }
                    
                    if ((i + 1) % 3 === 0 && i < slidesData.length - 1) {
                        notes += `---\n\n`;
                    }
                    
                    if ((i + 1) % 2 === 0) {
                        editor.value = notes;
                        editor.scrollTop = editor.scrollHeight;
                        updateWordCount();
                        await new Promise(r => setTimeout(r, 100));
                    }
                }
                
                // Summary Section
                notes += `---\n\n`;
                notes += `## üéØ Chapter Summary\n\n`;
                
                const allTerms = [];
                slidesData.forEach(slide => {
                    const analysis = analyzeSlideContent(slide);
                    allTerms.push(...analysis.terms);
                });
                
                const uniqueTerms = [...new Set(allTerms)].slice(0, 8);
                notes += `This lecture covers **${slidesData.length} ${currentFileType === 'slides' ? 'slides' : 'sections'}** focusing on ${uniqueTerms.slice(0, 3).join(', ')}. `;
                notes += `Key areas include understanding ${uniqueTerms[3] || 'the core concepts'} and their applications. `;
                notes += `Pay special attention to the relationships between ${uniqueTerms[0] || 'theory'} and ${uniqueTerms[1] || 'practice'}.\n\n`;
                
                notes += `## üìù Exam Preparation\n\n`;
                notes += `### Key Concepts to Memorize:\n`;
                uniqueTerms.forEach(term => {
                    notes += `‚Ä¢ ${term}\n`;
                });
                
                notes += `\n### Potential Exam Questions:\n`;
                notes += `1. Explain the significance of ${uniqueTerms[0] || 'the main topic'} in context.\n`;
                notes += `2. Compare and contrast ${uniqueTerms[1] || 'concept A'} and ${uniqueTerms[2] || 'concept B'}.\n`;
                notes += `3. Describe the progression from ${slidesData[0]?.title || 'introduction'} to ${slidesData[slidesData.length-1]?.title || 'conclusion'}.\n`;
                notes += `4. Analyze the relationship between theory and application presented.\n\n`;
                
                notes += `### Review Checklist:\n`;
                notes += `- [ ] Review all bold terms and definitions\n`;
                notes += `- [ ] Understand the ${slidesData.length}-part structure\n`;
                notes += `- [ ] Prepare to explain ${uniqueTerms.slice(0,3).join(', ')}\n`;
                notes += `- [ ] Review extracted diagrams\n\n`;
                
                notes += `---\n*Generated by UniNotes AI*`;
                
                editor.value = notes;
                updatePreview();
                updateWordCount();
                
                document.getElementById('downloadBtn').disabled = false;
                
            } catch (error) {
                console.error('Generation error:', error);
                showAlert('Error generating notes: ' + error.message);
            } finally {
                isGenerating = false;
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('statusBar').style.display = 'none';
            }
        }

        function setMode(mode) {
            const editBtn = document.getElementById('editBtn');
            const previewBtn = document.getElementById('previewBtn');
            const editor = document.getElementById('notesEditor');
            const preview = document.getElementById('notesPreview');
            
            if (mode === 'edit') {
                editor.style.display = 'block';
                preview.style.display = 'none';
                editBtn.classList.add('active');
                previewBtn.classList.remove('active');
            } else {
                editor.style.display = 'none';
                preview.style.display = 'block';
                updatePreview();
                editBtn.classList.remove('active');
                previewBtn.classList.add('active');
            }
        }

        function updatePreview() {
            let md = document.getElementById('notesEditor').value;
            
            md = md
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                .replace(/^‚Ä¢ (.*$)/gm, '<li>$1</li>')
                .replace(/\[ \]/g, '<input type="checkbox" style="margin-right: 0.5rem;">')
                .replace(/\[x\]/g, '<input type="checkbox" checked style="margin-right: 0.5rem;">')
                .replace(/---/g, '<hr style="border: none; border-top: 1px solid var(--border); margin: 2rem 0;">');
            
            md = md.replace(/(<li>.*<\/li>)/s, '<ul style="margin-left: 1.5rem; margin-bottom: 1rem;">$1</ul>');
            
            document.getElementById('notesPreview').innerHTML = md;
        }

        function updateWordCount() {
            const text = document.getElementById('notesEditor').value;
            const count = text.trim() ? text.trim().split(/\s+/).length : 0;
            document.getElementById('wordCount').textContent = `${count} words`;
        }

        function insertImage(idx) {
            const img = currentImages[idx];
            const markdown = `\n\n![Slide ${img.slide} Image](${img.src})\n*Figure: Visual from Slide ${img.slide}*\n\n`;
            
            const editor = document.getElementById('notesEditor');
            const pos = editor.selectionStart;
            editor.value = editor.value.slice(0, pos) + markdown + editor.value.slice(pos);
            updateWordCount();
        }

        function downloadMarkdown() {
            const content = document.getElementById('notesEditor').value;
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `class-notes-${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadPDF() {
            const content = document.getElementById('notesEditor').value;
            const title = document.getElementById('fileName').textContent;
            
            // Create PDF-ready HTML
            const pdfHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Class Notes - ${title}</title>
                    <style>
                        @page { size: A4; margin: 20mm; }
                        body {
                            font-family: Georgia, 'Times New Roman', serif;
                            line-height: 1.6;
                            color: #000;
                            max-width: 210mm;
                            margin: 0 auto;
                            padding: 20px;
                            font-size: 11pt;
                        }
                        h1 { 
                            color: #1e3a8a; 
                            border-bottom: 2px solid #3b82f6; 
                            padding-bottom: 10px;
                            font-size: 24pt;
                            margin-top: 0;
                        }
                        h2 { 
                            color: #1e40af; 
                            margin-top: 24px;
                            font-size: 18pt;
                            border-bottom: 1px solid #e5e7eb;
                            padding-bottom: 5px;
                        }
                        h3 { 
                            color: #374151;
                            font-size: 14pt;
                            margin-top: 18px;
                        }
                        ul { 
                            margin-left: 20px; 
                            margin-bottom: 16px;
                        }
                        li { 
                            margin-bottom: 8px;
                            text-align: justify;
                        }
                        strong { 
                            color: #7c3aed;
                            font-weight: 600;
                        }
                        hr {
                            border: none;
                            border-top: 1px solid #e5e7eb;
                            margin: 24px 0;
                        }
                        .header-info {
                            background: #f3f4f6;
                            padding: 10px 15px;
                            border-radius: 5px;
                            margin-bottom: 20px;
                            font-size: 10pt;
                            color: #6b7280;
                        }
                        img {
                            max-width: 100%;
                            height: auto;
                            margin: 10px 0;
                            border: 1px solid #e5e7eb;
                        }
                        @media print {
                            body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header-info">
                        <strong>Source:</strong> ${title}<br>
                        <strong>Generated:</strong> ${new Date().toLocaleDateString()}
                    </div>
                    ${convertMarkdownToHTML(content)}
                </body>
                </html>
            `;
            
            // Convert markdown to HTML for PDF
            function convertMarkdownToHTML(md) {
                return md
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^‚Ä¢ (.*$)/gm, '<li>$1</li>')
                    .replace(/<\/li>\n<li>/g, '</li><li>')
                    .replace(/<li>(.*?)<\/li>/gs, '<ul><li>$1</li></ul>')
                    .replace(/---/g, '<hr>')
                    .replace(/!\[.*?\]\((.*?)\)/g, '<img src="$1" style="max-width: 100%;">')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/^(.+)$/gm, (match) => {
                        if (!match.startsWith('<')) return '<p>' + match + '</p>';
                        return match;
                    });
            }
            
            // Open in new window and auto-print
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(pdfHTML);
            printWindow.document.close();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                // Optionally close after print dialog
                // printWindow.close();
            }, 500);
        }

        function showAlert(message) {
            const alert = document.getElementById('alert');
            document.getElementById('alertText').textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function resetApp() {
            slidesData = [];
            currentImages = [];
            currentFileType = 'document';
            document.getElementById('notesEditor').value = '';
            updateWordCount();
            fileInput.value = '';
            uploadSection.style.display = 'block';
            workspace.classList.remove('active');
            document.getElementById('downloadBtn').disabled = true;
            
            dropZone.innerHTML = `
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <h3 style="margin-bottom: 0.5rem; font-size: 1.25rem;">Drop your lecture file here</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">or click to browse</p>
                <div style="display: flex; justify-content: center; gap: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                    <span style="padding: 0.25rem 0.75rem; background: rgba(255,255,255,0.1); border-radius: 0.25rem;">üìä PowerPoint</span>
                    <span style="padding: 0.25rem 0.75rem; background: rgba(255,255,255,0.1); border-radius: 0.25rem;">üìÑ PDF</span>
                    <span style="padding: 0.25rem 0.75rem; background: rgba(255,255,255,0.1); border-radius: 0.25rem;">üìù Word</span>
                </div>
            `;
        }

        document.getElementById('notesEditor').addEventListener('input', () => {
            updateWordCount();
            if (document.getElementById('notesPreview').style.display !== 'none') {
                updatePreview();
            }
        });
    </script>
</body>
</html>